
#include "oled.h"
#include "kv58_i2c_soft.h"

#define X_WIDTH 128
#define Y_WIDTH 64


const uint8_t F8X16[]=
{
/*   */
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
/* ! */
0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x37,0x00,0x00,0x00,0x00,
/* " */
0x00,0x00,0x80,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x03,0x00,0x03,0x00,0x00,0x00,
/* # */
0x20,0x20,0xF8,0x20,0x20,0xF8,0x20,0x00,0x02,0x1E,0x03,0x02,0x1F,0x02,0x02,0x00,
/* $ */
0x00,0xE0,0x90,0xFC,0x10,0x30,0x00,0x00,0x00,0x1C,0x30,0x7F,0x23,0x1E,0x00,0x00,
/* % */
0x70,0x88,0xF8,0xC0,0x30,0x08,0x00,0x00,0x00,0x18,0x06,0x01,0x0F,0x11,0x0F,0x00,
/* & */
0x00,0x30,0xF8,0x48,0x78,0x00,0x00,0x00,0x06,0x0F,0x10,0x13,0x1E,0x0E,0x1B,0x00,
/* ' */
0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,
/* ( */
0x00,0x00,0x80,0x60,0x18,0x04,0x00,0x00,0x00,0x00,0x07,0x18,0x20,0x40,0x00,0x00,
/* ) */
0x00,0x00,0x00,0x04,0x18,0xE0,0x00,0x00,0x00,0x00,0x20,0x30,0x0C,0x03,0x00,0x00,
/* * */
0x00,0xC0,0x80,0xE0,0x80,0x80,0x40,0x00,0x02,0x02,0x03,0x0F,0x01,0x02,0x02,0x00,
/* + */
0x00,0x00,0x00,0xE0,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x0F,0x01,0x01,0x01,0x00,
/* , */
0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x01,0x00,0x00,0x00,
/* - */
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,
/* . */
0x00,0x00,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x00,0x00,0x00,
/* / */
0x00,0x00,0x00,0x00,0xC0,0x30,0x08,0x00,0x20,0x18,0x04,0x03,0x00,0x00,0x00,0x00,
/* 0 */
0x00,0xF0,0x08,0x08,0x08,0x38,0xE0,0x00,0x00,0x0F,0x08,0x10,0x18,0x0E,0x03,0x00,
/* 1 */
0x00,0x00,0x20,0x10,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,
/* 2 */
0x00,0x18,0x08,0x08,0x88,0xF8,0x00,0x00,0x00,0x18,0x14,0x12,0x11,0x10,0x10,0x00,
/* 3 */
0x00,0x10,0x08,0x88,0x88,0x78,0x00,0x00,0x00,0x0C,0x18,0x10,0x18,0x0F,0x06,0x00,
/* 4 */
0x00,0x00,0xC0,0x20,0x18,0xF8,0x00,0x00,0x02,0x03,0x02,0x02,0x02,0x1F,0x02,0x00,
/* 5 */
0x00,0xF8,0x48,0x48,0x48,0x88,0x00,0x00,0x04,0x08,0x10,0x10,0x18,0x0F,0x03,0x00,
/* 6 */
0x00,0x80,0xE0,0x70,0x48,0x80,0x80,0x00,0x00,0x0F,0x18,0x10,0x10,0x08,0x0F,0x00,
/* 7 */
0x00,0x08,0x08,0x08,0xC8,0x38,0x08,0x00,0x00,0x00,0x18,0x0F,0x01,0x00,0x00,0x00,
/* 8 */
0x00,0x78,0x88,0x88,0x88,0x78,0x00,0x00,0x06,0x0F,0x10,0x10,0x10,0x0D,0x06,0x00,
/* 9 */
0x60,0xF8,0x08,0x08,0x08,0xF8,0x60,0x00,0x00,0x00,0x11,0x0D,0x07,0x01,0x00,0x00,
/* : */
0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0x00,0x00,0x00,0x00,
/* ; */
0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0x00,0x00,0x00,0x00,
/* < */
0x00,0x00,0x80,0x40,0x20,0x10,0x08,0x00,0x00,0x03,0x06,0x04,0x08,0x10,0x20,0x00,
/* = */
0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x00,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x00,
/* > */
0x00,0x08,0x10,0x20,0x60,0x40,0x80,0x00,0x00,0x18,0x08,0x04,0x02,0x01,0x00,0x00,
/* ? */
0x00,0x30,0x08,0x08,0x88,0x78,0x00,0x00,0x00,0x00,0x00,0x1B,0x00,0x00,0x00,0x00,
/* @ */
0xE0,0x10,0xC8,0x28,0xE8,0x28,0xF0,0x00,0x07,0x08,0x13,0x14,0x13,0x0C,0x03,0x00,
/* A */
0x00,0x00,0xE0,0x18,0xF8,0x80,0x00,0x00,0x10,0x1F,0x03,0x03,0x03,0x0F,0x1C,0x00,
/* B */
0x00,0xF8,0x88,0x88,0x88,0x78,0x30,0x00,0x00,0x1F,0x10,0x10,0x18,0x0D,0x0F,0x00,
/* C */
0x00,0xF0,0x18,0x08,0x08,0x18,0x30,0x00,0x00,0x0F,0x08,0x10,0x10,0x0C,0x06,0x00,
/* D */
0x00,0xF8,0x08,0x08,0x08,0xF0,0xE0,0x00,0x00,0x1F,0x10,0x18,0x08,0x0F,0x03,0x00,
/* E */
0x00,0xF8,0x88,0x88,0x88,0x88,0x08,0x00,0x00,0x1F,0x10,0x10,0x10,0x10,0x10,0x00,
/* F */
0x00,0xF8,0x88,0x88,0x88,0x88,0x08,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,
/* G */
0x00,0xF0,0x08,0x08,0x08,0x38,0x20,0x00,0x00,0x0F,0x18,0x10,0x11,0x0D,0x1F,0x00,
/* H */
0x00,0xF8,0x80,0x80,0x80,0xF8,0xF8,0x00,0x00,0x1F,0x00,0x00,0x00,0x1F,0x1F,0x00,
/* I */
0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,
/* J */
0x00,0x00,0x00,0x00,0x00,0xF8,0xF8,0x00,0x00,0x0E,0x18,0x10,0x18,0x0F,0x03,0x00,
/* K */
0x00,0xF8,0xC0,0xE0,0x30,0x08,0x00,0x00,0x00,0x1F,0x00,0x01,0x07,0x0C,0x10,0x00,
/* L */
0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x10,0x10,0x10,0x10,0x10,0x00,
/* M */
0x00,0xF8,0xF8,0x00,0xE0,0x38,0xF8,0x00,0x00,0x1F,0x01,0x1E,0x07,0x00,0x1F,0x00,
/* N */
0x00,0xF8,0x70,0xC0,0x00,0xF8,0xF8,0x00,0x00,0x1F,0x00,0x01,0x07,0x1F,0x1F,0x00,
/* O */
0xC0,0xF8,0x08,0x08,0x08,0x78,0xE0,0x00,0x01,0x0F,0x18,0x10,0x18,0x0F,0x07,0x00,
/* P */
0x00,0xF8,0x08,0x08,0x08,0xD8,0x70,0x00,0x00,0x1F,0x01,0x01,0x01,0x00,0x00,0x00,
/* Q */
0xC0,0xF8,0x08,0x08,0x08,0x78,0xE0,0x00,0x01,0x0F,0x18,0x10,0x1E,0x1E,0x07,0x00,
/* R */
0x00,0xF8,0x88,0x88,0x88,0xF8,0x70,0x00,0x00,0x1F,0x00,0x00,0x03,0x0C,0x10,0x00,
/* S */
0x00,0x78,0xC8,0x88,0x88,0x18,0x00,0x00,0x00,0x0C,0x18,0x10,0x11,0x0F,0x06,0x00,
/* T */
0x00,0x08,0x08,0xF8,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,
/* U */
0x00,0xF8,0x00,0x00,0x00,0xF8,0xF8,0x00,0x00,0x0F,0x18,0x10,0x10,0x0F,0x07,0x00,
/* V */
0x08,0x78,0xC0,0x00,0x80,0xF0,0x18,0x00,0x00,0x00,0x07,0x1C,0x0F,0x00,0x00,0x00,
/* W */
0x38,0xF0,0xC0,0x38,0xF0,0x80,0xF8,0x00,0x00,0x1F,0x1F,0x00,0x07,0x1F,0x00,0x00,
/* X */
0x00,0x18,0x30,0xC0,0x70,0x18,0x00,0x00,0x10,0x1C,0x07,0x01,0x03,0x0C,0x10,0x00,
/* Y */
0x00,0x18,0x60,0x80,0xE0,0x38,0x08,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,
/* Z */
0x00,0x08,0x08,0x88,0x68,0x38,0x08,0x00,0x00,0x1C,0x17,0x11,0x10,0x10,0x10,0x00,
/* [ */
0x00,0x00,0xFC,0x04,0x04,0x04,0x00,0x00,0x00,0x00,0x7F,0x40,0x40,0x40,0x00,0x00,
/* \ */
0x00,0x0C,0x70,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x0E,0x30,0x40,0x00,
/* ] */
0x00,0x00,0x04,0x04,0xFC,0x00,0x00,0x00,0x00,0x00,0x40,0x40,0x7F,0x00,0x00,0x00,
/* ^ */
0x00,0x00,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x01,0x00,0x00,
/* _ */
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,
/* ` */
0x00,0x00,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x00,0x00,0x00,
/* a */
0x00,0x40,0x60,0x20,0x20,0xC0,0x00,0x00,0x00,0x07,0x09,0x09,0x05,0x0F,0x08,0x00,
/* b */
0x00,0xF8,0xC0,0x40,0x40,0x80,0x00,0x00,0x00,0x1F,0x08,0x10,0x10,0x0F,0x07,0x00,
/* c */
0x00,0xC0,0x60,0x20,0x20,0x40,0x00,0x00,0x00,0x07,0x0C,0x08,0x08,0x06,0x02,0x00,
/* d */
0x00,0x80,0x40,0x40,0x40,0xF8,0x00,0x00,0x00,0x0F,0x18,0x10,0x18,0x1F,0x00,0x00,
/* e */
0x00,0xC0,0xA0,0xA0,0xA0,0xC0,0x80,0x00,0x00,0x07,0x0C,0x08,0x08,0x06,0x02,0x00,
/* f */
0x00,0x40,0x40,0xF8,0x48,0x48,0x08,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,
/* g */
0x00,0xE0,0x90,0x10,0xB0,0x70,0x10,0x00,0x00,0x1F,0x12,0x13,0x12,0x14,0x0C,0x00,
/* h */
0x00,0xF8,0x80,0x40,0x40,0xC0,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x1F,0x1F,0x00,
/* i */
0x00,0x00,0x00,0xC8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,
/* j */
0x00,0x00,0x00,0x00,0x00,0xE4,0x00,0x00,0x00,0x00,0x30,0x20,0x20,0x1F,0x00,0x00,
/* k */
0x00,0xF8,0x00,0x00,0x80,0x40,0x00,0x00,0x00,0x1F,0x02,0x01,0x06,0x18,0x10,0x00,
/* l */
0x00,0x00,0x00,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x00,0x00,0x00,0x00,
/* m */
0xE0,0x40,0x20,0xE0,0x40,0x20,0xE0,0x00,0x0F,0x00,0x00,0x0F,0x00,0x00,0x0F,0x00,
/* n */
0x00,0xE0,0x40,0x20,0x20,0xE0,0x80,0x00,0x00,0x0F,0x00,0x00,0x00,0x0F,0x0F,0x00,
/* o */
0x00,0xC0,0x60,0x20,0x20,0xC0,0x80,0x00,0x00,0x07,0x0C,0x08,0x08,0x06,0x03,0x00,
/* p */
0x00,0xF0,0x30,0x10,0x10,0xE0,0xC0,0x00,0x00,0x1F,0x02,0x04,0x04,0x03,0x01,0x00,
/* q */
0x00,0xE0,0x10,0x10,0x10,0xF0,0x00,0x00,0x00,0x03,0x06,0x04,0x06,0x1F,0x00,0x00,
/* r */
0x00,0x00,0xE0,0x40,0x20,0x20,0x00,0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x00,0x00,
/* s */
0x00,0xC0,0xA0,0x20,0x20,0x60,0x00,0x00,0x00,0x04,0x09,0x09,0x09,0x07,0x00,0x00,
/* t */
0x00,0x40,0x40,0xF0,0xF0,0x40,0x40,0x00,0x00,0x00,0x00,0x07,0x1F,0x10,0x10,0x00,
/* u */
0x00,0xE0,0x00,0x00,0x00,0xE0,0xE0,0x00,0x00,0x07,0x08,0x08,0x04,0x0F,0x0F,0x00,
/* v */
0x00,0xE0,0x80,0x00,0x00,0xE0,0x20,0x00,0x00,0x00,0x07,0x0C,0x07,0x01,0x00,0x00,
/* w */
0x60,0xC0,0x80,0x60,0xC0,0x00,0xE0,0x00,0x00,0x0F,0x0F,0x00,0x07,0x0F,0x00,0x00,
/* x */
0x00,0x20,0xC0,0x80,0xC0,0x60,0x00,0x00,0x00,0x0C,0x06,0x01,0x02,0x0C,0x08,0x00,
/* y */
0x00,0x70,0xC0,0x00,0x80,0xF0,0x10,0x00,0x00,0x10,0x11,0x0E,0x03,0x00,0x00,0x00,
/* z */
0x00,0x20,0x20,0x20,0xE0,0x60,0x00,0x00,0x00,0x0C,0x0A,0x09,0x08,0x08,0x08,0x00,
/* { */
0x00,0x00,0x00,0xF8,0x04,0x00,0x00,0x00,0x00,0x00,0x01,0x7F,0x40,0x00,0x00,0x00,
/* | */
0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,
/* } */
0x00,0x00,0x04,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x01,0x00,0x00,0x00,
/* ~ */
0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x01,0x01,0x02,0x02,0x01,0x00,
  
};


//内部使用
static void OLED_WrDat(uint8_t data)
{
	IIC_start();
    send_ch((OLED_DEV_ADDR<<1) | 0x00);     //发送器件地址加写位
	send_ch((OLED_DATA));   //发送 co + D/C
	send_ch(data);       //发送需要写入的数据
	IIC_stop();
}


//内部使用
static void OLED_WrCmd(uint8_t cmd)
{
	IIC_start();
    send_ch((OLED_DEV_ADDR<<1) | 0x00);     //发送器件地址加写位
	send_ch((OLED_COMMAND));        //发送 co + D/C
	send_ch(cmd);       //发送需要写入的数据
	IIC_stop();
}


//-------------------------------------------------------------------------------------------------------------------
//  @brief      OLED显示坐标设置
//  @param      x			x轴坐标设置
//  @param      y			y轴坐标设置
//  @return     void
//  @since      v1.0
//  Sample usage:   内部使用
//-------------------------------------------------------------------------------------------------------------------
static void OLED_Set_Pos(uint8_t x, uint8_t y)
{
    //设置页地址
    OLED_WrCmd(0xb0+y);
    //设置起始列
    OLED_WrCmd(((x&0xf0)>>4)|0x10);
    OLED_WrCmd((x&0x0f)|0x01);
}


//字体颜色为白色，底色为黑色
void OLED_P8x16Str(uint8_t x,uint8_t y,uint8_t ch[])
{
	uint8_t c=0,i=0,j=0;
	
	while (ch[j]!='\0')
	{
	  	c =ch[j]-32;
	  	if(x>120){x=0;y++;}
		
	  	OLED_Set_Pos(x,y);
	  	for(i=0;i<8;i++)	OLED_WrDat(F8X16[c*16+i]);
	  	  
	  	OLED_Set_Pos(x,y+1);
	  	for(i=0;i<8;i++)	OLED_WrDat(F8X16[c*16+i+8]);
	  	  
	  	x+=8;
	  	j++;
	}
}

//有符号数，-2147483648~2147483647
void OLED_P8x16Num(uint8_t x,uint8_t y,int32_t num)
{
    uint8_t i,ch[10];
    int32_t n=num;
    if(num<0)
    {
        OLED_P8x16Str(x,y,"-");
        num = -num;
        n=num;
        x+=8;
    }
    //先求整数的位数
    for(i=1;n/10!=0;i++)
    {
        n/=10;
    }
    ch[i]='\0';
    n=num;
    while(i--)
    {
        ch[i]=n%10+48;
        n/=10;
    }
    OLED_P8x16Str(x,y,ch);
}

//-------------------------------------------------------------------------------------------------------------------
//  @brief      OLED清屏函数
//  @param      bmp_data	填充颜色选着(0x00 or 0xff)
//  @return     void
//  @since      v1.0
//  Sample usage:			
//-------------------------------------------------------------------------------------------------------------------
void OLED_Fill(uint8_t bmp_data)
{
	uint8_t y,x;
	
	for(y=0;y<8;y++)
	{
		OLED_WrCmd(0xb0+y);
		OLED_WrCmd(0x00);
		OLED_WrCmd(0x10);
		for(x=0;x<X_WIDTH;x++)	OLED_WrDat(bmp_data); 
	}
}


//-------------------------------------------------------------------------------------------------------------------
//  @brief      OLED初始化函数
//  @param      NULL
//  @return     void
//  @since      v1.0
//  Sample usage:			
//-------------------------------------------------------------------------------------------------------------------
void OLED_Init(void)
{
	OLED_WrCmd(0xae);//--turn off oled panel
	OLED_WrCmd(0x20);//-Set Page Addressing Mode (0x00/0x01/0x02)
	OLED_WrCmd(0x02);//0x00: Horizontal 0x01: Vertical  0x02: Page  Addressing Mode
    OLED_WrCmd(0xB0);//Set Page Start
    
    //列地址分成两次发送,先发了列低地址,再发了列高地址,合起来就是0x00列
	OLED_WrCmd(0x00);//---set low column address
	OLED_WrCmd(0x10);//---set high column address
	
    OLED_WrCmd(0x40);//--set start line address  Set Mapping RAM Display Start Line (0x00~0x3F)
	OLED_WrCmd(0x81);//--set contrast control register
	OLED_WrCmd(0xff); // Set SEG Output Current Brightness
	OLED_WrCmd(0xa1);//--Set SEG/Column Mapping     0xa0左右反置 0xa1正常
	OLED_WrCmd(0xc8);//Set COM/Row Scan Direction   0xc0上下反置 0xc8正常
	OLED_WrCmd(0xa6);//--set normal display
    
    //multiplex ratio???
	OLED_WrCmd(0xa8);//--set multiplex ratio(1 to 64)
	OLED_WrCmd(0x3f);//--1/64 duty
    
    OLED_WrCmd(0xa4);//a4: Output follows RAM content   a5: Entire display ON,Output ignores RAM content
	OLED_WrCmd(0xd3);//-set display offset	Shift Mapping RAM Counter (0x00~0x3F)
	OLED_WrCmd(0x00);//-not offset
	OLED_WrCmd(0xd5);//--set display clock divide ratio/oscillator frequency
	OLED_WrCmd(0x80);//--set divide ratio, Set Clock as 100 Frames/Sec
	OLED_WrCmd(0xd9);//--set pre-charge period
	OLED_WrCmd(0xf1);//Set Pre-Charge as 15 Clocks & Discharge as 1 Clock
	OLED_WrCmd(0xda);//--set com pins hardware configuration
	OLED_WrCmd(0x12);
	OLED_WrCmd(0xdb);//--set vcomh

    //没找到指令
    OLED_WrCmd(0x20);//Set VCOM Deselect Level

	OLED_WrCmd(0x8d);//--set Charge Pump enable/disable
	OLED_WrCmd(0x14);//--set(0x10) disable
	OLED_WrCmd(0xa4);// Disable Entire Display On (0xa4/0xa5)
	OLED_WrCmd(0xa6);// Disable Inverse Display On (0xa6/a7)
    OLED_WrCmd(0xaf);//--turn on oled panel
    
    //全亮,忽视ram内容或是根据ram内容点亮点阵
//    OLED_WrCmd(0xa5);// Disable Entire Display On (0xa4/0xa5)

    //背景填充：0x00为黑色，0xff为白色
    OLED_Fill(0x00);
}



